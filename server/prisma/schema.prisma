// server/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// MODELOS PRINCIPALES - Versión compatible con SQLite
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // RELACIONES
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  documents      Document[]
  subscriptions  BillingSubscription[]
  preferences    UserPreferences? // NUEVA RELACIÓN
  customFields   CustomField[]    // NUEVA RELACIÓN
  templates      ExtractionTemplate[] // NUEVA RELACIÓN

  @@map("users")
  @@index([email])
  @@index([organizationId])
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELACIONES
  users      User[]
  documents  Document[]
  templates  ExtractionTemplate[]

  @@map("organizations")
}

model Document {
  id          String   @id @default(cuid())
  filename    String
  fileUrl     String
  fileSize    Int
  fileType    String
  // AGREGAR CONTRACT_CERTIFICATION
  documentType String   // "INVOICE", "RECEIPT", "CONTRACT", "CONTRACT_CERTIFICATION", "OTHER"
  status      String   @default("PENDING") // "PENDING", "PROCESSING", "COMPLETED", "FAILED"
  uploadedAt  DateTime @default(now())
  processedAt DateTime?

  // RELACIONES
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  processing  DocumentProcessing?

  @@map("documents")
  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([uploadedAt])
}

model DocumentProcessing {
  id          String   @id @default(cuid())
  documentId  String   @unique
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // CAMPOS DE RESULTADO DE IA
  extractedData String?
  confidence   Float?
  processingEngine String? @default("unknown")

  // METADATA DE PROCESAMIENTO
  startedAt   DateTime?
  completedAt DateTime?
  error       String?

  @@map("document_processings")
  @@index([documentId])
}

model ExtractionTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  fields      String   // Almacenar JSON schema como string
  sampleData  String?  // Almacenar datos de ejemplo como string JSON

  // RELACIONES
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // NUEVOS CAMPOS PARA PERSONALIZACIÓN
  userId      String?  // Si es null, es template de sistema
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  isDefault   Boolean  @default(false)
  category    String   @default("general")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("extraction_templates")
  @@index([userId])
  @@index([category])
}

model BillingSubscription {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan        String   @default("FREE") // "FREE", "PRO", "BUSINESS"
  stripeSubscriptionId String? @unique
  stripeCustomerId    String? @unique
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("billing_subscriptions")
  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
}

// NUEVOS MODELOS PARA PERSONALIZACIÓN
model UserPreferences {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  useCase     String   @default("CONTRACT_CERTIFICATION") // CONTRACT_CERTIFICATION, INVOICE_PROCESSING, LEGAL_DOCUMENTS, CUSTOM
  customFields String? // JSON con campos personalizados
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("user_preferences")
}

model CustomField {
  id          String   @id @default(cuid())
  name        String
  type        String   // text, number, date, currency, percentage, boolean
  description String?
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@map("custom_fields")
  @@unique([userId, name])
}
return new PrismaClient({
  log: ['query', 'error', 'warn'],
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
})
